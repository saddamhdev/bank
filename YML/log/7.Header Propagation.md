Excellent question üëè
‡¶è‡¶ñ‡¶® ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶∏‡¶≤ microservice-level tracing ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶ö‡¶æ‡¶ö‡ßç‡¶õ‡ßã‡•§

‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶æ ‡¶π‡¶≤‡ßã:

> user-service ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶∞‡ßá‡¶ï‡¶ü‡¶æ downstream service (‡¶Ø‡ßá‡¶Æ‡¶® account-service) call ‡¶ï‡¶∞‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá log ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá?

‡¶è‡¶ü‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡ß©‡¶ü‡¶æ ‡¶≤‡ßá‡ßü‡¶æ‡¶∞‡ßá:

---

# üè¶ 1Ô∏è‚É£ Header Propagation (‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£)

Gateway ‚Üí main-service ‚Üí user-service ‚Üí account-service

‡¶è‡¶á ‡¶™‡ßÅ‡¶∞‡ßã chain ‡¶è:

* correlationId
* traceId
* spanId

**HTTP header ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá propagate ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§**

---

## ‚úÖ What Must Be Sent in Header

```http
X-Correlation-Id: 142bfa0c-019b-4c08-9c6b-e86226bb255e
traceparent: 00-32c43a1679454163b8e76f0538ec9fe4-d31f6f989ab24b35-01
```

Micrometer + OpenTelemetry automatically sends `traceparent`.

‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá manually ‡¶∂‡ßÅ‡¶ß‡ßÅ correlationId propagate ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§

---

# üè¶ 2Ô∏è‚É£ WebClient / RestTemplate ‡¶è Propagation

## ‚úÖ WebClient Example (Reactive)

User-service ‡¶Ø‡¶¶‡¶ø account-service call ‡¶ï‡¶∞‡ßá:

```java
@Bean
public WebClient webClient(WebClient.Builder builder) {
    return builder
            .filter((request, next) -> {
                String correlationId = MDC.get("correlationId");

                ClientRequest newRequest = ClientRequest.from(request)
                        .header("X-Correlation-Id", correlationId)
                        .build();

                return next.exchange(newRequest);
            })
            .build();
}
```

‡¶è‡¶ñ‡¶®:

* correlationId ‡¶Ø‡¶æ‡¶¨‡ßá
* traceId ‡¶Ø‡¶æ‡¶¨‡ßá (auto by tracing)

---

# üè¶ 3Ô∏è‚É£ Downstream Service ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶¨‡ßá?

account-service ‡¶è:

* GlobalFilter ‡¶¨‡¶æ OncePerRequestFilter ‡¶è header ‡¶•‡ßá‡¶ï‡ßá correlationId ‡¶™‡ßú‡¶¨‡ßá
* MDC.put ‡¶ï‡¶∞‡¶¨‡ßá
* ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ log ‡¶ï‡¶∞‡¶¨‡ßá

Example:

```java
String correlationId = request.getHeader("X-Correlation-Id");
if (correlationId != null) {
    MDC.put("correlationId", correlationId);
}
```

Tracing ‡¶•‡¶æ‡¶ï‡¶≤‡ßá traceId auto available ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§

---

# üß† Result ‡¶ï‡ßÄ ‡¶π‡¶¨‡ßá?

‡¶ß‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ï:

```text
correlationId = REQ-777
traceId = T1
```

Logs:

### Gateway

```json
{
 "service":"gateway-service",
 "correlationId":"REQ-777",
 "traceId":"T1"
}
```

### user-service

```json
{
 "service":"user-service",
 "correlationId":"REQ-777",
 "traceId":"T1"
}
```

### account-service

```json
{
 "service":"account-service",
 "correlationId":"REQ-777",
 "traceId":"T1"
}
```

---

# üè¶ Important Difference

| Field         | Behavior                  |
| ------------- | ------------------------- |
| correlationId | Same across all services  |
| traceId       | Same across all services  |
| spanId        | Different in each service |

---

# üî• That‚Äôs How You Know Downstream Error

If account-service fails:

You search:

```text
traceId=T1
```

You‚Äôll see:

* Gateway ‚Üí OK
* user-service ‚Üí OK
* account-service ‚Üí ERROR

Root cause clear.

---

# üè¶ Real Fintech Architecture

In real banking:

* correlationId = business transaction ID
* traceId = distributed tracing
* Kafka headers also carry them
* Every service reads & sets MDC
* Splunk/ELK aggregates

---

# üéØ Final Simple Rule

For downstream logging to work:

1Ô∏è‚É£ correlationId must be passed via header
2Ô∏è‚É£ tracing must be enabled in all services
3Ô∏è‚É£ each service must extract header ‚Üí put in MDC

---

If you want, I can now:

* Show full gateway ‚Üí user ‚Üí account propagation code (production style)
* Show Kafka header propagation
* Draw full architecture flow diagram
* Show how to auto-propagate without writing filter manually

Which level you want next? üöÄ
